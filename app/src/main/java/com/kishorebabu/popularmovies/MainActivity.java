package com.kishorebabu.popularmovies;import android.app.ProgressDialog;import android.os.Bundle;import android.support.v7.app.AppCompatActivity;import android.support.v7.widget.GridLayoutManager;import android.support.v7.widget.RecyclerView;import android.view.Menu;import android.view.MenuInflater;import android.view.MenuItem;import android.view.View;import android.widget.AdapterView;import android.widget.AdapterView.OnItemSelectedListener;import android.widget.ArrayAdapter;import android.widget.Spinner;import android.widget.Toast;import com.kishorebabu.popularmovies.model.Movie;import com.kishorebabu.popularmovies.model.MoviesList;import java.util.List;import retrofit.Callback;import retrofit.Response;import retrofit.Retrofit;import timber.log.Timber;public class MainActivity extends AppCompatActivity {    private static final int GRID_SPAN_WIDTH = 2;    public static final String PREF_LANGUAGE = "en"; //English    public static final int MIN_VOTE_COUNT = 100;    private MovieDBApi movieDBApi;    private RecyclerView moviesGrid;    private MoviesGridAdapter moviesGridAdapter;    private ProgressDialog progressDialog;    private int maxMostPopularMoviePages;    private int maxHighestRatedMoviePages;    private EndlessRecyclerOnScrollListener mostPopularMoviesScroller;    private EndlessRecyclerOnScrollListener highestRatedMoviesScroller;    @Override    protected void onCreate(Bundle savedInstanceState) {        super.onCreate(savedInstanceState);        setContentView(R.layout.activity_main);        Timber.tag("MainActivity");        movieDBApi = PopularMoviesApplication.getServiceSharedInstance();        progressDialog = new ProgressDialog(this);        progressDialog.setMessage(getString(R.string.one_moment_please));        moviesGrid = (RecyclerView) findViewById(R.id.moviesGrid);        GridLayoutManager gridLayoutManager = new GridLayoutManager(this, GRID_SPAN_WIDTH);        moviesGrid.setLayoutManager(gridLayoutManager);        moviesGrid.setHasFixedSize(true);        mostPopularMoviesScroller = new EndlessRecyclerOnScrollListener(gridLayoutManager) {            @Override            public void onLoadMore(int current_page) {                if (current_page <= maxMostPopularMoviePages)                    fetchMostPopularMoviesByPage(current_page);                else                    Toast.makeText(MainActivity.this, R.string.end_of_list, Toast.LENGTH_SHORT).show();            }        };        highestRatedMoviesScroller = new EndlessRecyclerOnScrollListener(gridLayoutManager) {            @Override            public void onLoadMore(int current_page) {                if (current_page <= maxHighestRatedMoviePages)                    fetchHighestRatedMoviesByPage(current_page);                else                    Toast.makeText(MainActivity.this, R.string.end_of_list, Toast.LENGTH_SHORT).show();            }        };    }    @Override    public boolean onCreateOptionsMenu(Menu menu) {        // Inflate the menu; this adds items to the action bar if it is present.        MenuInflater menuInflater = getMenuInflater();        menuInflater.inflate(R.menu.main, menu);        MenuItem menuItem = menu.findItem(R.id.spinner_sort_order);        View spinnerView = menuItem.getActionView();        if (spinnerView instanceof Spinner) {            final Spinner spinner = (Spinner) spinnerView;            ArrayAdapter<CharSequence> listAdapter = ArrayAdapter.createFromResource(this,                    R.array.sort_order,                    android.R.layout.simple_spinner_dropdown_item);            spinner.setAdapter(listAdapter);            spinner.setOnItemSelectedListener(new OnItemSelectedListener() {                @Override                public void onItemSelected(AdapterView<?> parent, View view, int position, long id) {                    Timber.v("position %d", position);                    switch (position) {                        case 0:                            moviesGrid.clearOnScrollListeners();                            moviesGrid.addOnScrollListener(mostPopularMoviesScroller);                            if (moviesGridAdapter != null)                                moviesGridAdapter.clearMovies();                            fetchMostPopularMoviesByPage(1);                            break;                        case 1:                            moviesGrid.clearOnScrollListeners();                            moviesGrid.addOnScrollListener(highestRatedMoviesScroller);                            if (moviesGridAdapter != null)                                moviesGridAdapter.clearMovies();                            fetchHighestRatedMoviesByPage(1);                            break;                        default:                            Timber.e("Unknown spinner position %d", position);                    }                }                @Override                public void onNothingSelected(AdapterView<?> parent) {                    Timber.v("Nothing is selected in sort order");                }            });        }        return true;    }    private void fetchMostPopularMoviesByPage(final int page) {        if (page == 1)            progressDialog.show();        movieDBApi.getMostPopularMovies(page, BuildConfig.TMDB_API_KEY).enqueue(new Callback<MoviesList>() {            @Override            public void onResponse(Response<MoviesList> response, Retrofit retrofit) {                if (progressDialog.isShowing())                    progressDialog.dismiss();                if (response.isSuccess()) {                    Timber.v("Fetched most popular movies successfully.");                    maxMostPopularMoviePages = response.body().getTotalPages();                    List<Movie> movies = response.body().getResults();                    Timber.v("Movies Count: %d, Page: %d", movies.size(), page);                    if (moviesGridAdapter == null)                        moviesGridAdapter = new MoviesGridAdapter(MainActivity.this);                    moviesGridAdapter.addMovies(movies);                    if (page == 1)                        moviesGrid.setAdapter(moviesGridAdapter);                } else {                    Timber.e("Failed to get movies, %s", response.raw().toString());                }            }            @Override            public void onFailure(Throwable t) {                Timber.e(t, "Failed to get highest rated movies.");            }        });    }    private void fetchHighestRatedMoviesByPage(final int page) {        if (page == 1)            progressDialog.show();        movieDBApi.getHighestRatedMovies(page, MIN_VOTE_COUNT, PREF_LANGUAGE, BuildConfig.TMDB_API_KEY).enqueue(new Callback<MoviesList>() {            @Override            public void onResponse(Response<MoviesList> response, Retrofit retrofit) {                if (progressDialog.isShowing())                    progressDialog.dismiss();                if (response.isSuccess()) {                    Timber.v("Fetched Highest rated movies successfully.");                    List<Movie> movies = response.body().getResults();                    Timber.v("Movies Count: %d", movies.size());                    maxHighestRatedMoviePages = response.body().getTotalPages();                    if (moviesGridAdapter == null)                        moviesGridAdapter = new MoviesGridAdapter(MainActivity.this);                    moviesGridAdapter.addMovies(movies);                    if (page == 1)                        moviesGrid.setAdapter(moviesGridAdapter);                }            }            @Override            public void onFailure(Throwable t) {                Timber.e(t, "Failed to get highest rated movies.");            }        });    }}